---
name: Publish VSCode Extension
on:
  release:
    types: [created]
permissions:
  contents: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false
      - name: Get Extension Version
        id: get_version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 20.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run headless tests
        uses: coactions/setup-xvfb@b6b4fcfb9f5a895edadc3bc76318fae0ac17c8b3 # v1
        with:
          run: npm test
      - name: Build Extension
        run: npm run package
      - name: Package Extension
        run: npm run vsce-package
      - name: Verify Package
        run: |
          echo "=== VSIX Package Verification ==="
          # List contents of the VSIX package
          echo "Listing package contents:"
          npx @vscode/vsce ls

          # Validate the package.json
          echo -e "\nValidating package.json:"
          if jq -e '.name and .publisher and .version and .engines.vscode' package.json > /dev/null; then
            echo "✅ package.json contains all required fields"
          else
            echo "❌ package.json is missing required fields"
            exit 1
          fi
      - name: Publish Extension
        if: success() && startsWith(github.ref, 'refs/tags/')
        run: npx @vscode/vsce publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      - name: Generate Changelog for Release Notes
        if: success() && startsWith(github.ref, 'refs/tags/')
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Create header for release notes
          cat > RELEASE_NOTES.md << EOF
          ## Release $VERSION
          EOF

          # Extract just the current version section from CHANGELOG.md
          sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' >> RELEASE_NOTES.md
          echo "=== RELEASE NOTES ==="
          cat RELEASE_NOTES.md
          echo "===================="
      - name: Create GitHub Release Assets
        if: success() && startsWith(github.ref, 'refs/tags/')
        run: |
          # Create a VERSION file that can be included in the release
          echo "${{ steps.get_version.outputs.version }}" > VERSION
      - name: Update GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1
        with:
          artifacts: zenml.vsix,VERSION
          bodyFile: RELEASE_NOTES.md
          allowUpdates: true
          tag: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
